let jwt = require("jsonwebtoken");
let validator = require("validator");
let createError = require('http-errors');
let shortid = require('shortid');

let User = require("../database/model/users");
let { invalidRes, COOKIES_AGE } = require('../config');
let i, flag;

flag = true;

//checking same origin of request and https protocol
const checkURLDetailsPage = (req, res, next)=>{
	invalidRes.data = "Invalid host OR Insecure protcols";
	console.log(req.protocol, req.hostname);
	if (process.env.NODE_ENV === 'PRODUCTION'){
		((req.protocol === "https") && (req.hostname === "www.mrnotes.me" || req.host === "mrnote.herokuapp.com")) ? next():next(createError(505));
	}else
		next();
};

//checking same origin of request and https protocol
const checkURLDetailsJSON = (req, res, next)=>{
	invalidRes.data = "Invalid host OR Insecure protcols";
	console.log(req.protocol, req.hostname);
	if (process.env.NODE_ENV === 'PRODUCTION'){
		((req.protocol === "https") && (req.hostname === "www.mrnotes.me" || req.host === "mrnote.herokuapp.com")) ? next():res.status(505).json(invalidRes);
	}else
		next();
};

//data validation of login or signup page 
const bodyDataValidCred = (req, res, next)=>{
	for (i in req.body){
		if (req.body[`${i}`] == ('' || null) || (i == "email" && !validator.isEmail(req.body[`${i}`]))) {
			res.status(302).redirect(`${req.path}/?q=Invalid User Details`);
			flag = false;
			break;
		} 
	}
	if(flag){
		flag = true;
		next();
	}
}; 

//data validation 
const bodyDataValidJSON = (req, res, next)=>{
	//console.log(req.path);
	invalidRes.data = "Invalid Data";
	for (i in req.body){
		if (req.body[`${i}`] == ('' || null) || (i == "email" && !validator.isEmail(req.body[`${i}`]))){
			res.json(invalidRes);
			flag = false;
			break;
		}
	} 
	if(flag){
		flag = true;
		next();
	}
}; 

//user cookies validation
const cookieValid = (req, res, next) =>{
	//extracting cookies from req parameter
  	let cookie = req.cookies.token;
	if (cookie != null){
		try{
			//token validation from jwt
			cookie = jwt.verify(cookie, process.env.JWT_SECRET);
			cookie = cookie.token;
			/*.populate("notes")*/
			User.findOne({cookie}).exec((err, data)=>{
				if (err) console.error.bind(err);
				if (data){
					req.data = data;
					//calling next process
					next();
				}else
					res.status(302).redirect("/login-signup");		  
			});
		}catch(err){
			res.json(invalidRes);
		}	
	}else
		res.status(302).redirect("/login-signup");
};

//uid validation generated by shortid
const validId = (req, res, next) => {
	flag = true;
	//console.log(req.params);
	for(i in req.params){
		//console.log(shortid.isValid(req.params[`${i}`]), req.params[`${i}`]);
		flag = (shortid.isValid(req.params[`${i}`])) ? true: false;
	}
	//console.log(flag);
	flag ? next():res.json(invalidRes);
};

/**
 * for token a random string is generated using library randomstring
 * generating jwt token with expiration time defined in cookies_age
 *
 * this function works as middleware & generate random string & token save into req.data
 */
const jwtCreate = (req, res, next) =>{
    const expiresIn = (COOKIES_AGE/1000);
    req.data = {
        token: null,
        jwt: null
    };
	req.data.token = shortid.generate();
    req.data.jwt = jwt.sign({ token: req.data.token }, process.env.JWT_SECRET, { expiresIn });
    next();
};

module.exports = { bodyDataValidCred, bodyDataValidJSON, validId, 
	cookieValid, checkURLDetailsPage, checkURLDetailsJSON, jwtCreate };